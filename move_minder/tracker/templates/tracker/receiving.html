<!DOCTYPE html>

{% extends 'base.html' %}

{% block title %}
Receiving | 
{% endblock %}

{% block main %}
<div class="md:relative w-screen h-screen ">
    <div id="camera-div" class="absolute w-screen h-screen top-0 left-0 right-0 bottom-0 bg-white dark:bg-slate-900 z-40 overflow-auto md:w-3/4 md:inset-x-[12.5%] lg:inset-x-1/4 md:bottom-auto lg:w-1/2 2xl:w-1/3 2xl:inset-x-1/3">
        <div class="w-full h-full mx-auto">
            <div class="flex justify-end py-3 md:py-4 lg:py-6 xl:py-8 w-full">
                <button id="close-camera-button" class="btn-square contrast">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="w-full relative">
                <video id="camera-feed" autoplay class="w-full h-full object-cover"></video>
                <canvas id="canvas" class="hidden w-full h-full object-cover"></canvas>
            </div>
            <div id="camera-controls" class="grid grid-cols-3 px-3 pt-6 pb-12 w-full items-center bg-white dark:bg-slate-900">
                <div class="flex justify-center items-center col-start-2">
                    <button id="snap-button" class="col-start-2 size-8 sm:size-9 md:size-10 xl:size-11 rounded-full ring-1 md:ring-2 ring-offset-2 lg:ring-offset-4 ring-slate-700 bg-slate-700 dark:ring-slate-200 dark:bg-slate-200 hover:bg-slate-500 hover:ring-slate-500 dark:hover:bg-slate-400 dark:hover:ring-slate-400"></button>
                </div>
                <div class="flex justify-end items-center">
                    <button id="flip-button" class="btn-square cool">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </div>
            <div id="canvas-controls" class="hidden p-3 md:p-4 lg:p-6 xl:p-8 w-full justify-between items-center">
                <button id="try-again-button" class="btn contrast space-x-2">
                    <i class="fa-solid fa-rotate-left"></i>
                    <span>Try Again</span>
                </button>
                <button id="save-button" class="btn success space-x-2">
                    <i class="fa-regular fa-circle-check"></i>
                    <span>Save</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const cameraFeed = document.getElementById("camera-feed");
    const canvas = document.getElementById("canvas");

    const webcam = new Webcam(cameraFeed, 'enviornment', canvas);

    {% if not parcel %}
    function startQRCodeScanner() {
        function detectQRCode() {
            const frame = webcam.snap();
    
            const tempImage = new Image();
            tempImage.src = frame;
            tempImage.onload = function() {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = tempImage.width;
                tempCanvas.height = tempImage.height;
                const tempContext = tempCanvas.getContext('2d');
                tempContext.drawImage(tempImage, 0, 0);

                const imageData = tempContext.getImageData(0, 0, tempImage.width, tempImage.height);

                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    const url = code.data;
                    if (isValidURL(url)) {
                        window.location.href = url; // Navigate to URL
                    } else {
                        console.log('QR code detected, but not a valid URL:', url);
                    }
                }
            };
        }
    
        setInterval(detectQRCode, 250);
    }
    
    function isValidURL(url) {
        // Implement your URL validation logic here
        // Example: Check if the URL matches a pattern or whitelist of URLs in your application
        // For simplicity, this example only checks if the URL starts with "http://" or "https://"
        if (!URL.canParse(url)) {
            console.log("Not a URL");
            return false;
        }
        const url_obj = URL(url);
        const location_host = window.location.hostname;
        return url_obj.hostname === location_host && url_obj.pathname = "{% url 'tracker:receiving' %}" && /^\?parcel=\d+/.test(url_obj.search);
    }
    
    window.addEventListener("load", () => webcam.start());
    window.addEventListener("load", () => startQRCodeScanner());
    {% endif %}
</script>
{% endblock %}